!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).ecSimpleTransform={})}(this,(function(e){"use strict";function n(e,n){if(!e)throw new Error(n)}function t(e,n){return e.hasOwnProperty(n)}const o={SUM:!0,COUNT:!0,FIRST:!0,LAST:!0,AVERAGE:!0,Q1:!0,Q2:!0,Q3:!0,MIN:!0,MAX:!0},i={AVERAGE:["COUNT"]},s={Q1:!0,Q2:!0,Q3:!0},l={MEDIAN:"Q2"};class r{constructor(e,n,t,o,i){this.collectionInfoList=[],this.gatheredValuesByGroup={},this.gatheredValuesNoGroup=[],this.needGatherValues=!1,this._collectionInfoMap={},this.method=t,this.name=o,this.index=e,this.indexInUpstream=n,this.needGatherValues=i}addCollectionInfo(e){this._collectionInfoMap[e.method]=this.collectionInfoList.length,this.collectionInfoList.push(e)}getCollectionInfo(e){return this.collectionInfoList[this._collectionInfoMap[e]]}gatherValue(e,n,t){if(t=+t,e){if(null!=n){const e=n+"";(this.gatheredValuesByGroup[e]||(this.gatheredValuesByGroup[e]=[])).push(t)}}else this.gatheredValuesNoGroup.push(t)}}const u={type:"ecSimpleTransform:aggregate",transform:function(e){var o;const l=e.upstream,u=e.config,a=function(e,t){const o=e.groupBy;let i;null!=o&&(i=t.getDimensionInfo(o),n(i,"Can not find dimension by `groupBy`: "+o));return i}(u,l),{finalResultDimInfoList:I,collectionDimInfoList:V}=function(e,o,l){const u=e.resultDimensions,a=[],c=[];let d=0;for(let e=0;e<u.length;e++){const h=u[e],m=o.getDimensionInfo(h.from);n(m,"Can not find dimension by `from`: "+h.from);const p=h.method;n(l.index!==m.index||null==p,`Dimension ${m.name} is the "groupBy" dimension, must not have any "method".`);const I=f(p);n(I,"method is required");const g=null!=h.name?h.name:m.name,V=new r(a.length,m.index,I,g,t(s,I));a.push(V);let x=!1;if(t(i,I)){x=!0;const e=i[I];for(let n=0;n<e.length;n++)V.addCollectionInfo({method:e[n],indexInLine:d++})}t(s,I)&&(x=!0),x&&c.push(V)}return{collectionDimInfoList:c,finalResultDimInfoList:a}}(u,l,a);let x;V.length&&(x=c(a,l,V,d,h));for(let e=0;e<V.length;e++){const n=V[e];n.__collectionResult=x,g(n.gatheredValuesNoGroup);const o=n.gatheredValuesByGroup;for(const e in o)t(o,e)&&g(o[e])}const U=null===(o=u.fillInnerGaps)||void 0===o?void 0:o.stepMs,y=a&&null!=U&&U>0?{stepMs:U,dimCount:I.length}:void 0,L=c(a,l,I,m,p,y),G=[];for(let e=0;e<I.length;e++)G.push(I[e].name);return{dimensions:G,data:L.outList}}};function a(e,n){const t=new Array(n);t[0]=e;for(let e=1;e<n;e++)t[e]=null;return t}function c(e,n,o,i,s,l){const r=[];let u;if(e){u={};let c=null;for(let f=0,d=n.count();f<d;f++){const d=n.retrieveValue(f,e.index);if(null==d)continue;const h=d+"";if(t(u,h)){s(n,f,u[h],o,e,d)}else{const t=+d;if(l&&null!=c&&t-c>l.stepMs){const{stepMs:e,dimCount:n}=l;for(let o=c+e;o<t;o+=e)r.push(a(o,n))}const s=i(n,f,o,e,d);r.push(s),u[h]=s,c=t}}}else{const e=i(n,0,o);r.push(e);for(let t=1,i=n.count();t<i;t++)s(n,t,e,o)}return{mapByGroup:u,outList:r}}function f(e){if(null==e)return"FIRST";let i=e.toUpperCase();return i=t(l,i)?l[i]:i,n(t(o,i),`Illegal method ${e}.`),i}const d=(e,n,t,o,i)=>{const s=[];for(let l=0;l<t.length;l++){const r=t[l],u=r.collectionInfoList;for(let t=0;t<u.length;t++){const l=u[t];s[l.indexInLine]=+V[l.method](e,n,r,o,i)}if(r.needGatherValues){const t=e.retrieveValue(n,r.indexInUpstream);r.gatherValue(o,i,t)}}return s},h=(e,n,t,o,i,s)=>{for(let l=0;l<o.length;l++){const r=o[l],u=r.collectionInfoList;for(let o=0;o<u.length;o++){const l=u[o],a=l.indexInLine;t[a]=+x[l.method](t[a],e,n,r,i,s)}if(r.needGatherValues){const t=e.retrieveValue(n,r.indexInUpstream);r.gatherValue(i,s,t)}}},m=(e,n,t,o,i)=>{const s=[];for(let l=0;l<t.length;l++){const r=t[l],u=r.method;s[l]=I(o,r)?i:V[u](e,n,r,o,i)}return s},p=(e,n,t,o,i,s)=>{for(let l=0;l<o.length;l++){const r=o[l];if(I(i,r))continue;const u=r.method;t[l]=x[u](t[l],e,n,r,i,s)}};function I(e,n){return e&&n.indexInUpstream===e.index}function g(e){e.sort(((e,n)=>e-n))}const V={SUM:(e,n,t)=>e.retrieveValue(n,t.indexInUpstream),COUNT:()=>1,FIRST:(e,n,t)=>e.retrieveValue(n,t.indexInUpstream),LAST:(e,n,t)=>e.retrieveValue(n,t.indexInUpstream),MIN:(e,n,t)=>e.retrieveValue(n,t.indexInUpstream),MAX:(e,n,t)=>e.retrieveValue(n,t.indexInUpstream),AVERAGE(e,n,t,o,i){const s=o?t.__collectionResult.mapByGroup[i+""]:t.__collectionResult.outList[0];return e.retrieveValue(n,t.indexInUpstream)/s[t.getCollectionInfo("COUNT").indexInLine]},Q1:(e,n,t,o,i)=>U(.25,t,o,i),Q2:(e,n,t,o,i)=>U(.5,t,o,i),Q3:(e,n,t,o,i)=>U(.75,t,o,i)},x={SUM:(e,n,t,o)=>e+n.retrieveValue(t,o.indexInUpstream),COUNT:e=>e+1,FIRST:e=>e,LAST:(e,n,t,o)=>n.retrieveValue(t,o.indexInUpstream),MIN:(e,n,t,o)=>Math.min(e,n.retrieveValue(t,o.indexInUpstream)),MAX:(e,n,t,o)=>Math.max(e,n.retrieveValue(t,o.indexInUpstream)),AVERAGE(e,n,t,o,i,s){const l=i?o.__collectionResult.mapByGroup[s+""]:o.__collectionResult.outList[0];return e+n.retrieveValue(t,o.indexInUpstream)/l[o.getCollectionInfo("COUNT").indexInLine]},Q1:(e,n,t,o)=>e,Q2:(e,n,t,o)=>e,Q3:(e,n,t,o)=>e};function U(e,n,t,o){return function(e,n){const t=(e.length-1)*n+1,o=Math.floor(t),i=+e[o-1],s=t-o;return s?i+s*(e[o]-i):i}(t?n.gatheredValuesByGroup[o+""]:n.gatheredValuesNoGroup,e)}e.aggregate=u,e.id={type:"ecSimpleTransform:id",transform:function(e){const n=e.upstream,t=e.config,o=t.dimensionIndex,i=t.dimensionName,s=n.cloneAllDimensionInfo();s[o]=i;const l=n.cloneRawData();for(let e=0,n=l.length;e<n;e++){l[e][o]=e}return{dimensions:s,data:l}}},Object.defineProperty(e,"__esModule",{value:!0})}));
